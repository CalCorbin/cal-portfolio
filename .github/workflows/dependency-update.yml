name: Weekly Dependency Update

on:
  schedule:
    # Runs at 7:00 AM UTC every Tuesday
    - cron: '0 7 * * 2'

  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm i

      - name: Run bump command
        run: npm run bump

      - name: Check for changes
        id: check-changes
        run: |
          git diff --quiet || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies"
          title: "Automated Dependency Updates"
          body: |
            This PR was automatically generated to update project dependencies.
            
            Updated dependencies via `npm run bump` command.
          branch: "chore/dependency-updates"
          branch-suffix: timestamp
          base: main

      - name: Enable auto-merge for PR
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge --auto --merge "${{ steps.create-pr.outputs.pull-request-number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}